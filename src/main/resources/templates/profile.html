<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - AnimeOdds</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/css/profile.css">

</head>
<body>
<div class="min-h-screen flex flex-col">
    <nav class="navbar">
        <div class="flex items-center gap-4">
            <span class="text-xl font-bold">AnimeOdds</span>
            <div class="points">Points: <span id="userPoints">0</span></div>
            <!-- Add exit button -->
            <a href="/home-page" class="button button-outline flex items-center gap-2">
                <i data-lucide="x"></i>
                Exit
            </a>
        </div>
        <div class="flex items-center gap-4">
            <button id="notificationsBtn" class="button button-outline">
                <i data-lucide="bell"></i>
            </button>
            <div class="avatar" id="userAvatar"></div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-6 md:py-8 pb-20 md:pb-8">
        <div class="mb-6">
            <h2 class="text-2xl md:text-3xl font-bold">Your Profile</h2>
            <p class="text-muted-foreground">Manage your account</p>
        </div>

        <div class="tab-list hide-scrollbar">
            <button class="tab active" data-tab="account">Account</button>
            <button class="tab" data-tab="history">Betting History</button>
        </div>

        <div class="tab-content">
            <div id="account" class="tab-pane active">
                <div class="card">
                    <div class="flex flex-col md:flex-row items-start gap-6">
                        <div class="avatar" id="profileAvatar"></div>
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold mb-4">Personal Information</h3>
                            <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-input" name="displayName" required minlength="2">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-input bg-gray-100 cursor-not-allowed" name="currentPass" readonly value="********">
                                </div>
                                <div class="form-group relative">
                                    <label class="form-label">New Password</label>
                                    <div class="relative">
                                        <input type="password" class="form-input pr-10" name="newPass" minlength="8" autocomplete="off">
                                        <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                                                id="togglePassword">
                                            <i data-lucide="eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <button type="submit" class="button button-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Replace the existing history tab content -->
            <div id="history" class="tab-pane">
                <div class="card">
                    <h3 class="text-xl font-bold mb-4">Betting History</h3>
                    <div id="bettingHistory" class="divide-y divide-gray-700">
                        <!-- Betting history will be inserted here -->
                    </div>
                    <div id="emptyHistory" class="text-center text-muted-foreground py-8 hidden">
                        Your betting history will appear here after placing bets
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // User state
    let user = null;


    // DOM Elements
    const tabs = document.querySelectorAll('.tab');
    const tabPanes = document.querySelectorAll('.tab-pane');
    const profileForm = document.getElementById('profileForm');


    async function init() {
        const historyContainer = document.getElementById('bettingHistory');
        const emptyHistory = document.getElementById('emptyHistory');

        try {
            // Parallel fetch requests for both user data and betting history
            const [userResponse, historyResponse] = await Promise.all([
                fetch('/api/users/current'),
                fetch('/api/users/betting-history')
            ]);

            if (!userResponse.ok) {
                throw new Error('Unauthorized');
            }

            // Process user data
            user = await userResponse.json();

            // Update UI with user data
            document.getElementById('userPoints').textContent = user.points;
            document.getElementById('userAvatar').textContent = user.username.slice(0, 2).toUpperCase();
            document.getElementById('profileAvatar').textContent = user.username.slice(0, 2).toUpperCase();

            // Fill form with user data
            profileForm.elements.displayName.value = user.username;
            profileForm.elements.email.value = user.email;
            profileForm.elements.currentPass.value = "********";
            profileForm.elements.newPass.value = "";

            // Process betting history
            if (historyResponse.ok) {
                const history = await historyResponse.json();

                if (history.length === 0) {
                    historyContainer.innerHTML = '';
                    emptyHistory.classList.remove('hidden');
                } else {
                    emptyHistory.classList.add('hidden');
                    historyContainer.innerHTML = history.map(bet => `
        <div class="p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
                <h4 class="font-medium text-white">${bet.category}</h4>
                <p class="text-muted-foreground">${bet.nominee}</p>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-accent font-bold">${bet.pointsBet} Points</span>
                <span class="text-muted-foreground text-sm">
                    ${new Date(bet.placedAt || bet.betDate).toLocaleDateString()}
                </span>
                <button
                    class="delete-bet-btn text-destructive hover:text-destructive/80"
                    onclick="deleteBet('${bet.id}')"
                >
                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                </button>
            </div>
        </div>
    `).join('');

                    lucide.createIcons();
                }
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Issue with loading user data', true);
        }
    }


    // Add the delete function
    async function deleteBet(betId) {
        if (!betId) {
            showToast('Error', 'Invalid bet ID', true);
            return;
        }

        try {
            const confirmed = await showConfirmDialog(
                'Delete Bet',
                'Are you sure you want to delete this bet? Your points will be refunded.'
            );

            if (!confirmed) return;

            const response = await fetch(`/bets/delete-bet/${betId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete bet');
            }

            showToast('Success', 'Bet deleted successfully! Your points have been refunded.', false);

            // Refresh the betting history and user data
            await init();
        } catch (error) {
            console.error('Error deleting bet:', error);
            showToast('Error', error.message || 'Failed to delete bet', true);
        }
    }

    // Add the confirmation dialog function if not already present
    function showConfirmDialog(title, message) {
        return new Promise((resolve) => {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
            <div class="bg-card p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-bold text-white mb-2">${title}</h3>
                <p class="text-muted-foreground mb-4">${message}</p>
                <div class="flex justify-end gap-2">
                    <button class="button button-outline" id="cancelBtn">Cancel</button>
                    <button class="button button-destructive" id="confirmBtn">Delete</button>
                </div>
            </div>
        `;

            document.body.appendChild(dialog);

            dialog.querySelector('#confirmBtn').addEventListener('click', () => {
                dialog.remove();
                resolve(true);
            });

            dialog.querySelector('#cancelBtn').addEventListener('click', () => {
                dialog.remove();
                resolve(false);
            });
        });
    }

    // Update the tab click handler to not reload history
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabPanes.forEach(p => p.classList.remove('active'));

            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);

    // Toast notification - modified to prevent multiple toasts
    function showToast(message, isError = false) {
        // Remove any existing toasts first
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) {
            existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 p-4 rounded-lg ${isError ? 'bg-red-600' : 'bg-green-600'} text-white toast-notification`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Start the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);


    const togglePassword = document.getElementById('togglePassword');
    const newPassInput = profileForm.elements.newPass;

    togglePassword.addEventListener('click', () => {
        // Toggle the password visibility
        const type = newPassInput.type === 'password' ? 'text' : 'password';
        newPassInput.type = type;

        // Update the icon element directly
        const iconElement = togglePassword.querySelector('i');
        if (iconElement) {
            iconElement.setAttribute('data-lucide', type === 'password' ? 'eye' : 'eye-off');
            lucide.createIcons({
                icons: {
                    target: iconElement
                }
            });
        }
    });




    // Add this to your profile.html script section
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(profileForm);

        // In your profile.html script section, update the password update section:
        if (formData.get('newPass')) {
            try {
                const response = await fetch('/api/users/update-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        oldPassword: formData.get('currentPass'),
                        newPassword: formData.get('newPass')
                    })
                });

                const responseText = await response.text();
                if (!response.ok) {
                    throw new Error(responseText);
                }

                showToast('Password updated successfully');
                profileForm.elements.newPass.value = '';
                profileForm.elements.currentPass.value = '********';
            } catch (error) {
                showToast(error.message || 'Failed to update password', true);
                return;
            }
        }

        // Handle profile update (username/email)
        try {
            const response = await fetch('/api/users/update-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: formData.get('displayName'),
                    email: formData.get('email')
                })
            });

            if (!response.ok) {
                throw new Error(await response.text());
            }

            // Update the UI with new user data
            await init();
            showToast('Profile updated successfully');
        } catch (error) {
            showToast(error.message || 'Failed to update profile', true);
        }
    });



</script>
</body>
</html>